<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>位置情報イベントアプリ</title>
    <!-- Tailwind CSSを読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* マップコンテナのスタイル */
        #map {
            height: calc(100vh - 150px); /* ボタンとイベントボタンの高さ分を引く */
            width: 100vw;  /* ビューポートの幅全体を使用 */
        }
        /* ロード中のメッセージのスタイル */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            z-index: 9999;
        }
        /* メッセージボックスのスタイル */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            text-align: center;
            display: none; /* 初期状態では非表示 */
        }
        .message-box button {
            background-color: #4F46E5;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 15px;
            cursor: pointer;
            border: none;
        }
        /* ナビゲーションボタンのコンテナスタイル */
        .navigation-buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            background-color: #ffffff;
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
            height: 70px; /* ボタンコンテナの高さ */
        }
        /* ナビゲーションボタンのスタイル */
        .nav-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, opacity 0.3s ease;
            margin: 0 10px;
        }
        .nav-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .nav-button.start {
            background-color: #10B981; /* エメラルドグリーン */
            color: white;
        }
        .nav-button.start:hover:not(:disabled) {
            background-color: #059669; /* 少し濃いエメラルドグリーン */
        }
        .nav-button.stop {
            background-color: #EF4444; /* 赤 */
            color: white;
        }
        .nav-button.stop:hover:not(:disabled) {
            background-color: #DC2626; /* 少し濃い赤 */
        }

        /* イベントボタンのコンテナスタイル */
        .event-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            background-color: #f0f0f0; /* 少し明るい背景 */
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
            height: 80px; /* イベントボタンコンテナの高さ */
        }
        /* イベントボタンのスタイル */
        .event-button {
            background-color: #3B82F6; /* 青 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .event-button:hover {
            background-color: #2563EB; /* 少し濃い青 */
            transform: translateY(-2px);
        }
        .event-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="font-sans antialiased flex flex-col h-screen">
    <!-- マップが表示されるdiv要素 -->
    <div id="map" class="flex-grow rounded-lg shadow-lg"></div>

    <!-- イベントボタンのコンテナ -->
    <div id="eventButtonContainer" class="event-button-container hidden">
        <button id="eventActionButton" class="event-button" onclick="handleEventButtonClick()">
            <span id="eventButtonText">イベントを発見！</span>
        </button>
    </div>

    <!-- ナビゲーションボタンのコンテナ -->
    <div class="navigation-buttons-container">
        <button id="startButton" class="nav-button start" onclick="startGeolocationTracking()">ナビ開始</button>
        <button id="stopButton" class="nav-button stop" onclick="stopGeolocationTracking()" disabled>ナビ停止</button>
    </div>

    <!-- ロード中のオーバーレイ -->
    <div id="loadingOverlay" class="loading-overlay">
        現在地を取得中...
    </div>

    <!-- メッセージボックス -->
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button onclick="hideMessageBox()">閉じる</button>
    </div>

    <script>
        // スクリプトの実行が開始されたことをログに出力
        console.log("Script execution started.");

        // Google Maps APIキーは空の文字列に設定します。Canvas環境が自動的に提供します。
        // 「for development purposes only」というメッセージが表示される場合、
        // これはAPIキーが不足しているか、無効である場合に表示されます。
        // Canvas環境では自動的にキーが提供されるため、この問題が続く場合は
        // 環境側の一時的な問題である可能性があります。
        // もしCanvas環境外で実行している場合は、ご自身のGoogle Cloudプロジェクトで
        // 有効なAPIキーを設定し、Google Maps JavaScript APIが有効になっていることを確認してください。
        // このメッセージは、コードの問題ではなく、APIキーの認証または読み込みの問題に起因します。
        const GOOGLE_MAPS_API_KEY = "";

        let map; // Googleマップオブジェクト
        let marker; // マーカーオブジェクト
        let watchId = null; // watchPositionのIDを保存するための変数
        let lastPosition = null; // 前回の位置情報を保存するための変数（移動方向計算用）
        let activeEventLocation = null; // 現在検出範囲内にあるイベント地点を保持する変数

        // デフォルトの位置情報 (東京駅) - 位置情報取得失敗時や初期表示に使用
        const DEFAULT_LAT = 35.681236;
        const DEFAULT_LNG = 139.767125;

        // イベント地点の定義
        const eventLocations = [
            {
                id: 'shinjukuGyoen',
                name: 'ryuiti',
                lat: 35.91508261392471,
                lng: 140.18757421836057,
                radius: 150,
                message: 'テストメッセージ！！',
                buttonVisible: false,
                marker: null
            },
            {
                id: 'tokyoTower',
                name: 'ryuugasaki',
                lat: 35.939439520005806, 
                lng: 140.17520637144244,
                radius: 80,
                message: 'テストメッセージ！！',
                buttonVisible: false,
                marker: null
            }
            // 以前の東京駅のイベント地点は削除されました
        ];

        // DOM要素の取得
        const loadingOverlay = document.getElementById('loadingOverlay');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const eventButtonContainer = document.getElementById('eventButtonContainer');
        const eventButtonText = document.getElementById('eventButtonText');

        // メッセージボックスを表示する関数
        function showMessageBox(message) {
            messageText.innerText = message;
            messageBox.style.display = 'block';
        }

        // メッセージボックスを非表示にする関数
        function hideMessageBox() {
            messageBox.style.display = 'none';
        }

        /**
         * 2点間の方位（方角、bearing）を計算する関数
         * @param {number} lat1 - 1点目の緯度
         * @param {number} lon1 - 1点目の経度
         * @param {number} lat2 - 2点目の緯度
         * @param {number} lon2 - 2点目の経度
         * @returns {number} 0-360度の範囲の方位（北が0度、東が90度）
         */
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;

            const dLon = toRad(lon2 - lon1);
            const lat1Rad = toRad(lat1);
            const lat2Rad = toRad(lat2);

            const y = Math.sin(dLon) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                      Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
            let bearing = toDeg(Math.atan2(y, x));

            // 0-360度の範囲に正規化
            return (bearing + 360) % 360;
        }

        /**
         * Googleマップを初期化または更新する関数
         * @param {number} latitude - 地図の中心とする緯度
         * @param {number} longitude - 地図の中心とする経度
         */
        function initMap(latitude, longitude) {
            console.log("initMap called with coordinates:", latitude, longitude);
            const currentLocation = { lat: latitude, lng: longitude };

            try {
                // google.mapsオブジェクトが利用可能かチェック
                if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.Map === 'undefined') {
                    const errorMessage = "Google Mapsオブジェクトが利用できません。APIキーの問題または読み込みエラーの可能性があります。";
                    console.error(errorMessage);
                    showMessageBox(errorMessage + " マップを表示できません。");
                    loadingOverlay.style.display = 'none';
                    return; // マップを初期化できないため処理を終了
                }

                if (map) {
                    // マップが既に初期化されている場合は、中心とマーカーを更新
                    map.setCenter(currentLocation);
                    marker.setPosition(currentLocation);
                    console.log("Map and marker updated to new location.");
                } else {
                    // マップを初めて初期化する
                    map = new google.maps.Map(document.getElementById("map"), {
                        center: currentLocation, // マップの中心を現在地に設定
                        zoom: 18, // ズームレベルを高く設定（ナビゲーション向け）
                        disableDefaultUI: true, // デフォルトのUIを非表示にする
                        zoomControl: true, // ズームコントロールを表示
                        streetViewControl: false, // ストリートビューコントロールを非表示
                        mapTypeControl: false, // マップタイプコントロールを非表示
                        fullscreenControl: false, // フルスクリーンコントロールを非表示
                        tilt: 45, // 地図に傾きを付けて3D感を出す（ナビゲーション向け）
                        // マップのスタイルを設定して明るくします
                        styles: [
                            {
                                featureType: "landscape", // 土地
                                elementType: "geometry",
                                stylers: [{ color: "#f5f5f5" }] // 明るい灰色
                            },
                            {
                                featureType: "road", // 道路
                                elementType: "geometry",
                                stylers: [{ color: "#ffffff" }] // 白
                            },
                            {
                                featureType: "water", // 水域
                                elementType: "geometry",
                                stylers: [{ color: "#c9e0f2" }] // 明るい青
                            },
                            {
                                featureType: "poi", // ランドマーク
                                elementType: "labels",
                                stylers: [{ visibility: "off" }] // POIラベルを非表示
                            },
                            {
                                featureType: "transit", // 公共交通機関
                                elementType: "labels",
                                stylers: [{ visibility: "off" }] // 交通機関ラベルを非表示
                            },
                            {
                                featureType: "administrative", // 行政区画
                                elementType: "labels",
                                stylers: [{ visibility: "off" }] // 行政ラベルを非表示
                            }
                        ]
                    });

                    // マーカーを現在地に配置（進行方向を示す矢印アイコンを使用）
                    marker = new google.maps.Marker({
                        position: currentLocation, // マーカーの位置を現在地に設定
                        map: map, // マーカーを表示するマップ
                        title: "現在地", // マーカーのタイトル
                        icon: { // カスタムアイコン（矢印）
                            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, // 前方閉じた矢印
                            scale: 6, // アイコンのサイズ
                            fillColor: '#FF0000', // 赤色
                            fillOpacity: 0.8, // 不透明度
                            strokeWeight: 0, // 枠線の太さ
                            rotation: 0 // 初期回転角度（動的に更新される）
                        }
                    });
                    console.log("Map and marker initialized.");

                    // イベント地点のマーカーを地図上に配置
                    eventLocations.forEach(location => {
                        location.marker = new google.maps.Marker({
                            position: { lat: location.lat, lng: location.lng },
                            map: map,
                            title: location.name,
                            icon: { // 例: 青い円のアイコン
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#0000FF', // 青色
                                fillOpacity: 0.6,
                                strokeWeight: 0
                            },
                            zIndex: 1 // ユーザーマーカーより下にする
                        });
                    });
                }

            } catch (e) {
                const errorMessage = "マップの初期化中にエラーが発生しました: " + e.message;
                console.error(errorMessage, e);
                showMessageBox(errorMessage + " マップを表示できません。");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Geolocation APIで現在地を継続的に取得する関数
        function startGeolocationTracking() {
            console.log("startGeolocationTracking called.");
            loadingOverlay.style.display = 'flex'; // ロード中を表示
            startButton.disabled = true; // 開始ボタンを無効化
            stopButton.disabled = false; // 停止ボタンを有効化

            if (navigator.geolocation) {
                // watchPositionを使用して位置情報を継続的に監視
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        console.log("Geolocation watch successful.");
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        const newLocation = { lat: latitude, lng: longitude };
                        const userLatLng = new google.maps.LatLng(latitude, longitude);

                        // マップとマーカーを更新
                        initMap(latitude, longitude); // 既存のマップとマーカーを更新する

                        // 前回の位置情報があれば、方位を計算して地図とマーカーの向きを更新
                        if (lastPosition && (newLocation.lat !== lastPosition.lat || newLocation.lng !== lastPosition.lng)) {
                            const bearing = calculateBearing(
                                lastPosition.lat, lastPosition.lng,
                                newLocation.lat, newLocation.lng
                            );
                            map.setHeading(bearing); // 地図の向きを回転
                            // マーカーアイコンの回転を更新
                            marker.setIcon({
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                scale: 6,
                                fillColor: '#FF0000',
                                fillOpacity: 0.8,
                                strokeWeight: 0,
                                rotation: bearing // マーカーアイコンの回転
                            });
                        }
                        lastPosition = newLocation; // 次回計算のために現在の位置を保存

                        // イベント地点のチェック
                        let foundActiveEvent = false;
                        eventLocations.forEach(location => {
                            const eventLatLng = new google.maps.LatLng(location.lat, location.lng);
                            // google.maps.geometry.spherical.computeDistanceBetween を使用して距離を計算
                            const distance = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, eventLatLng);

                            if (distance <= location.radius) {
                                // 検出範囲内に入った場合
                                if (!location.buttonVisible) {
                                    // 初めて範囲内に入った場合、ボタンを表示する準備
                                    activeEventLocation = location; // このイベントをアクティブに設定
                                    eventButtonText.innerText = `${location.name}を発見！`;
                                    eventButtonContainer.classList.remove('hidden');
                                    location.buttonVisible = true;
                                    console.log(`イベント地点「${location.name}」の範囲内に入りました。`);
                                }
                                foundActiveEvent = true; // 少なくとも一つのイベントがアクティブ
                            } else {
                                // 検出範囲外に出た場合
                                if (location.buttonVisible) {
                                    // 範囲外に出た場合、ボタンを非表示にする
                                    if (activeEventLocation && activeEventLocation.id === location.id) {
                                        // 現在アクティブなイベントがこの地点の場合のみ非表示
                                        eventButtonContainer.classList.add('hidden');
                                        activeEventLocation = null;
                                    }
                                    location.buttonVisible = false;
                                    console.log(`イベント地点「${location.name}」の範囲外に出ました。`);
                                }
                            }
                        });

                        // どのイベントもアクティブでない場合、イベントボタンを非表示にする
                        if (!foundActiveEvent && !eventButtonContainer.classList.contains('hidden')) {
                            eventButtonContainer.classList.add('hidden');
                            activeEventLocation = null;
                        }


                        loadingOverlay.style.display = 'none';
                    },
                    (error) => {
                        console.error("Geolocation watch error:", error);
                        loadingOverlay.style.display = 'none'; // ロード中を非表示
                        startButton.disabled = false; // 開始ボタンを有効化
                        stopButton.disabled = true; // 停止ボタンを無効化
                        let errorMessage = "現在地を取得できませんでした。";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "位置情報の利用が許可されていません。ブラウザの設定を確認してください。";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "位置情報が利用できません。";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "位置情報の取得がタイムアウトしました。電波の良い場所へ移動するか、インターネット接続を確認してください。";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage = "不明なエラーが発生しました。";
                                break;
                        }
                        console.error("Geolocationエラー:", errorMessage);
                        showMessageBox(errorMessage); // エラーメッセージを表示
                        // マップが初期化されていない場合は、デフォルトの位置で初期化
                        if (!map) {
                            initMap(DEFAULT_LAT, DEFAULT_LNG);
                        }
                    },
                    {
                        enableHighAccuracy: true, // 高精度な位置情報を要求
                        timeout: 20000, // タイムアウト（ミリ秒）を20秒に設定
                        maximumAge: 0 // キャッシュされた位置情報を使用せず、常に最新の情報を取得
                    }
                );
            } else {
                console.log("Geolocation not supported.");
                loadingOverlay.style.display = 'none'; // ロード中を非表示
                startButton.disabled = false; // 開始ボタンを有効化
                stopButton.disabled = true; // 停止ボタンを無効化
                const errorMessage = "お使いのブラウザはGeolocationをサポートしていません。";
                console.error(errorMessage);
                showMessageBox(errorMessage); // エラーメッセージを表示
                // サポートされていない場合は東京駅をデフォルト位置としてマップを初期化
                if (!map) {
                    initMap(DEFAULT_LAT, DEFAULT_LNG);
                }
            }
        }

        // イベントボタンがクリックされた時の処理
        function handleEventButtonClick() {
            if (activeEventLocation) {
                console.log(`イベントボタンがクリックされました: ${activeEventLocation.name}`);
                showMessageBox(activeEventLocation.message); // イベントメッセージを表示
                // activeEventLocation.eventCompleted = true; // イベントを完了済みにマーク - 何度でも発生させるため削除
                // eventButtonContainer.classList.add('hidden'); // ボタンを非表示にする <-- この行を削除
                
                // イベント地点のマーカーの色を変更する（例: 完了したことを示す色） - 何度でも発生させるため削除
                // if (activeEventLocation.marker) {
                //     activeEventLocation.marker.setIcon({
                //         path: google.maps.SymbolPath.CIRCLE,
                //         scale: 8,
                //         fillColor: '#FFD700', // 金色に変更
                //         fillOpacity: 0.8,
                //         strokeWeight: 0
                //     });
                // }
                // activeEventLocation = null; // アクティブなイベントをリセット <-- この行を削除
            }
        }

        // ナビゲーションを停止する関数
        function stopGeolocationTracking() {
            console.log("stopGeolocationTracking called.");
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId); // 位置情報の監視を停止
                watchId = null; // IDをリセット
                lastPosition = null; // 前回の位置情報をリセット
                showMessageBox("ナビゲーションを停止しました。");
                startButton.disabled = false; // 開始ボタンを有効化
                stopButton.disabled = true; // 停止ボタンを無効化
                eventButtonContainer.classList.add('hidden'); // イベントボタンも非表示にする
                activeEventLocation = null; // アクティブなイベントをリセット

                // マップの向きを北向き（0度）にリセット
                if (map) {
                    map.setHeading(0);
                    // マーカーアイコンの回転もリセット
                    marker.setIcon({
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 6,
                        fillColor: '#FF0000',
                        fillOpacity: 0.8,
                        strokeWeight: 0,
                        rotation: 0
                    });
                }
            }
        }

        // Google Maps APIスクリプトを動的に読み込む関数
        function loadGoogleMapsScript() {
            console.log("loadGoogleMapsScript called.");
            const script = document.createElement("script");
            // Google Maps APIを読み込み、コールバック関数としてonGoogleMapsLoadedを指定
            // 距離計算のために 'geometry' ライブラリも読み込みます
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=onGoogleMapsLoaded&libraries=geometry`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            script.onerror = () => {
                console.error("Google Maps API script failed to load.");
                loadingOverlay.style.display = 'none'; // ロード中を非表示
                const errorMessage = "Google Maps APIの読み込みに失敗しました。インターネット接続を確認してください。";
                console.error(errorMessage);
                showMessageBox(errorMessage); // エラーメッセージを表示
                // APIの読み込みに失敗した場合でも、デフォルト位置でマップを初期化
                initMap(DEFAULT_LAT, DEFAULT_LNG);
            };
        }

        // Google Maps APIがロードされた後に実行されるコールバック関数
        function onGoogleMapsLoaded() {
            console.log("Google Maps API loaded successfully.");
            // まずはデフォルトの位置でマップを初期化して表示
            initMap(DEFAULT_LAT, DEFAULT_LNG);
            // ボタンの初期状態を設定
            startButton.disabled = false;
            stopButton.disabled = true;
        }

        // ウィンドウがロードされたらGoogle Maps APIスクリプトを読み込む
        window.onload = loadGoogleMapsScript;
    </script>
</body>
</html>
