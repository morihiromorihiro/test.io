<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>位置情報ゲーム</title>
    <!-- Tailwind CSSを読み込みます -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSSを読み込みます -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzxHjDStlfgVNssIfSUEV" crossorigin=""/>
    <style>
        /* 全体のレイアウト */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            font-family: 'Inter', sans-serif; /* フォントをInterに設定 */
            overflow: hidden; /* スクロールバーが出ないようにする */
        }

        /* マップコンテナのスタイル */
        #map {
            height: calc(100vh - 150px); /* ボタンとイベントボタンの高さ分を引く */
            width: 100vw;  /* ビューポートの幅全体を使用 */
            /* Leafletマップのデフォルトスタイルを上書き */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
        }
        /* ロード中のメッセージのスタイル */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            z-index: 9999;
        }
        /* メッセージボックスのスタイル */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            text-align: center;
            display: none; /* 初期状態では非表示 */
        }
        .message-box button {
            background-color: #4F46E5;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 15px;
            cursor: pointer;
            border: none;
        }
        /* ナビゲーションボタンのコンテナスタイル */
        .navigation-buttons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            background-color: #ffffff;
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
            height: 70px; /* ボタンコンテナの高さ */
        }
        /* ナビゲーションボタンのスタイル */
        .nav-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, opacity 0.3s ease;
            margin: 0 10px;
        }
        .nav-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .nav-button.start {
            background-color: #10B981; /* エメラルドグリーン */
            color: white;
        }
        .nav-button.start:hover:not(:disabled) {
            background-color: #059669; /* 少し濃いエメラルドグリーン */
        }
        .nav-button.stop {
            background-color: #EF4444; /* 赤 */
            color: white;
        }
        .nav-button.stop:hover:not(:disabled) {
            background-color: #DC2626; /* 少し濃い赤 */
        }

        /* イベントボタンのコンテナスタイル */
        .event-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            background-color: #f0f0f0; /* 少し明るい背景 */
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
            height: 80px; /* イベントボタンコンテナの高さ */
        }
        /* イベントボタンのスタイル */
        .event-button {
            background-color: #3B82F6; /* 青 */
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .event-button:hover {
            background-color: #2563EB; /* 少し濃い青 */
            transform: translateY(-2px);
        }
        .event-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .hidden {
            display: none !important;
        }

        /* タイトル画面のスタイル */
        #titleScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, #6EE7B7, #34D399); /* グラデーション背景 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001; /* 最前面に表示 */
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        #titleScreen h1 {
            font-size: 3.5rem;
            font-weight: extra-bold;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }
        #titleScreen .start-game-button {
            background-color: #FBBF24; /* アンバー */
            color: #333;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        #titleScreen .start-game-button:hover {
            background-color: #F59E0B; /* 少し濃いアンバー */
            transform: translateY(-4px);
        }
        #titleScreen .start-game-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* ゲーム画面のコンテナ */
        #gameScreen {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* Leafletカスタムマーカーのスタイル */
        .custom-user-marker {
            background-color: transparent;
            border: none;
            text-align: center;
        }
        .custom-user-marker svg {
            transform-origin: center;
            transition: transform 0.3s ease-out; /* スムーズな回転 */
        }
    </style>
</head>
<body class="font-sans antialiased">
    <!-- タイトル画面 -->
    <div id="titleScreen">
        <h1>位置情報ゲーム</h1>
        <button id="startGameButton" class="start-game-button">ゲームスタート</button>
    </div>

    <!-- ゲーム画面 (最初は非表示) -->
    <div id="gameScreen" class="hidden">
        <!-- マップが表示されるdiv要素 -->
        <div id="map" class="flex-grow rounded-lg shadow-lg"></div>

        <!-- イベントボタンのコンテナ -->
        <div id="eventButtonContainer" class="event-button-container hidden">
            <button id="eventActionButton" class="event-button" onclick="handleEventButtonClick()">
                <span id="eventButtonText">イベントを発見！</span>
            </button>
        </div>

        <!-- ナビゲーションボタンのコンテナ -->
        <div class="navigation-buttons-container">
            <button id="startButton" class="nav-button start" onclick="startGeolocationTracking()">ナビ開始</button>
            <button id="stopButton" class="nav-button stop" onclick="stopGeolocationTracking()" disabled>ナビ停止</button>
        </div>
    </div>

    <!-- ロード中のオーバーレイ -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        現在地を取得中...
    </div>

    <!-- メッセージボックス -->
    <div id="messageBox" class="message-box hidden">
        <p id="messageText"></p>
        <button onclick="hideMessageBox()">閉じる</button>
    </div>

    <!-- Leaflet JavaScriptを読み込みます -->
    <script id="leafletJsScript" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/4K+g7eTVBwtBPq/2TaABn" crossorigin=""></script>

    <script>
        // スクリプトの実行が開始されたことをログに出力
        console.log("Script execution started.");

        // LeafletとOpenStreetMapを使用する場合、APIキーは通常必要ありません。
        const GOOGLE_MAPS_API_KEY = ""; // Leafletでは使用されません

        let map; // Leafletマップオブジェクト
        let marker; // Leafletマーカーオブジェクト (ユーザー現在地)
        let watchId = null; // watchPositionのIDを保存するための変数
        let lastPosition = null; // 前回の位置情報を保存するための変数（移動方向計算用）
        let activeEventLocation = null; // 現在検出範囲内にあるイベント地点を保持する変数

        // デフォルトの位置情報 (東京駅) - 位置情報取得失敗時や初期表示に使用
        const DEFAULT_LAT = 35.681236;
        const DEFAULT_LNG = 139.767125;

        // イベント地点の定義
        const eventLocations = [
            {
                id: 'ryuiti',
                name: 'ryuiti',
                lat: 35.91508261392471,
                lng: 140.18757421836057,
                radius: 150, // 検出範囲（メートル）
                message: 'テストメッセージ！！',
                buttonVisible: false, // ボタンが表示されているか
                marker: null // Leafletマーカーオブジェクトを格納
            },
            {
                id: 'ryuugasaki',
                name: 'ryuugasaki',
                lat: 35.939439520005806, 
                lng: 140.17520637144244,
                radius: 80,
                message: 'テストメッセージ！！',
                buttonVisible: false,
                marker: null
            }
        ];

        // DOM要素の取得
        const titleScreen = document.getElementById('titleScreen');
        const gameScreen = document.getElementById('gameScreen');
        const startGameButton = document.getElementById('startGameButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const eventButtonContainer = document.getElementById('eventButtonContainer');
        const eventButtonText = document.getElementById('eventButtonText');

        // メッセージボックスを表示する関数
        function showMessageBox(message) {
            messageText.innerText = message;
            messageBox.classList.remove('hidden'); // hiddenクラスを削除して表示
        }

        // メッセージボックスを非表示にする関数
        function hideMessageBox() {
            messageBox.classList.add('hidden'); // hiddenクラスを追加して非表示
        }

        /**
         * 2点間の方位（方角、bearing）を計算する関数
         * @param {number} lat1 - 1点目の緯度
         * @param {number} lon1 - 1点目の経度
         * @param {number} lat2 - 2点目の緯度
         * @param {number} lon2 - 2点目の経度
         * @returns {number} 0-360度の範囲の方位（北が0度、東が90度）
         */
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;

            const dLon = toRad(lon2 - lon1);
            const lat1Rad = toRad(lat1);
            const lat2Rad = toRad(lat2);

            const y = Math.sin(dLon) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) -
                      Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
            let bearing = toDeg(Math.atan2(y, x));

            // 0-360度の範囲に正規化
            return (bearing + 360) % 360;
        }

        /**
         * 2つの緯度経度間の距離をメートル単位で計算する（Haversine公式）
         * @param {number} lat1 - 1点目の緯度
         * @param {number} lon1 - 1点目の経度
         * @param {number} lat2 - 2点目の緯度
         * @param {number} lon2 - 2点目の経度
         * @returns {number} 距離（メートル）
         */
        function getDistanceBetweenPoints(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球の半径（メートル）
            const φ1 = lat1 * Math.PI / 180; // 緯度をラジアンに変換
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180; // 緯度の差をラジアンに変換
            const Δλ = (lon2 - lon1) * Math.PI / 180; // 経度の差をラジアンに変換

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // 距離を計算
            return d;
        }

        /**
         * Leafletマップを初期化または更新する関数
         * @param {number} latitude - 地図の中心とする緯度
         * @param {number} longitude - 地図の中心とする経度
         */
        function initMap(latitude, longitude) {
            console.log("initMap called with coordinates:", latitude, longitude);
            const currentLocation = [latitude, longitude]; // Leafletは配列形式の緯度経度を好む

            try {
                // Leafletオブジェクトが利用可能かチェック
                if (typeof L === 'undefined' || typeof L.map === 'undefined') {
                    const errorMessage = "Leafletマップオブジェクトが利用できません。ライブラリの読み込みエラーの可能性があります。";
                    console.error(errorMessage);
                    showMessageBox(errorMessage + " マップを表示できません。");
                    loadingOverlay.classList.add('hidden');
                    return;
                }

                if (map) {
                    // マップが既に初期化されている場合は、中心とマーカーを更新
                    map.setView(currentLocation, map.getZoom()); // 中心を更新し、ズームレベルは維持
                    marker.setLatLng(currentLocation); // マーカーの位置を更新
                    console.log("Map and marker updated to new location.");
                } else {
                    // マップを初めて初期化する
                    map = L.map('map').setView(currentLocation, 18); // 'map'はHTMLのdivのID, 18はズームレベル

                    // OpenStreetMapのタイルレイヤーを追加
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    // カスタムアイコン（ユーザー現在地を示す矢印）
                    const userArrowIcon = L.divIcon({
                        className: 'custom-user-marker',
                        html: '<div style="transform-origin: center; transform: rotate(0deg);"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 22H22L12 2Z" fill="#FF0000"/></svg></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24] // アイコンの中心を下端に設定
                    });

                    // マーカーを現在地に配置
                    marker = L.marker(currentLocation, { icon: userArrowIcon }).addTo(map);
                    console.log("Map and user marker initialized.");

                    // イベント地点のマーカーを地図上に配置
                    eventLocations.forEach(location => {
                        const eventCircleIcon = L.divIcon({
                            className: 'custom-event-marker',
                            html: '<div style="background-color: #0000FF; width: 16px; height: 16px; border-radius: 50%; opacity: 0.6;"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8] // アイコンの中心に設定
                        });
                        location.marker = L.marker([location.lat, location.lng], { icon: eventCircleIcon }).addTo(map);
                    });
                }

            } catch (e) {
                const errorMessage = "マップの初期化中にエラーが発生しました: " + e.message;
                console.error(errorMessage, e);
                showMessageBox(errorMessage + " マップを表示できません。");
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Geolocation APIで現在地を継続的に取得する関数
        function startGeolocationTracking() {
            console.log("startGeolocationTracking called.");
            loadingOverlay.classList.remove('hidden');
            startButton.disabled = true;
            stopButton.disabled = false;

            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        console.log("Geolocation watch successful.");
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        const newLocation = { lat: latitude, lng: longitude };
                        const userLatLng = [latitude, longitude]; // Leafletは配列形式の緯度経度を好む

                        // マップとマーカーを更新
                        initMap(latitude, longitude); // 既存のマップとマーカーを更新する

                        // 前回の位置情報があれば、方位を計算してマーカーの向きを更新
                        if (lastPosition && (newLocation.lat !== lastPosition.lat || newLocation.lng !== lastLocation.lng)) {
                            const bearing = calculateBearing(
                                lastPosition.lat, lastPosition.lng,
                                newLocation.lat, newLocation.lng
                            );
                            // LeafletマーカーのSVG要素を取得して回転
                            const markerElement = marker.getElement();
                            if (markerElement) {
                                const arrowElement = markerElement.querySelector('svg');
                                if (arrowElement) {
                                    arrowElement.style.transform = `rotate(${bearing}deg)`;
                                }
                            }
                            // Leafletマップ自体を回転させる機能は標準ではありません。
                            // マップの中心を移動させることでナビゲーション感を出すことができます。
                            map.panTo(userLatLng);
                        }
                        lastPosition = newLocation; // 次回計算のために現在の位置を保存

                        // イベント地点のチェック
                        let foundActiveEvent = false;
                        eventLocations.forEach(location => {
                            // getDistanceBetweenPoints を使用して距離を計算
                            const distance = getDistanceBetweenPoints(userLatLng[0], userLatLng[1], location.lat, location.lng);

                            if (distance <= location.radius) {
                                // 検出範囲内に入った場合
                                if (!location.buttonVisible) {
                                    activeEventLocation = location;
                                    eventButtonText.innerText = `${location.name}を発見！`;
                                    eventButtonContainer.classList.remove('hidden');
                                    location.buttonVisible = true;
                                    console.log(`イベント地点「${location.name}」の範囲内に入りました。`);
                                }
                                foundActiveEvent = true;
                            } else {
                                // 検出範囲外に出た場合
                                if (location.buttonVisible) {
                                    if (activeEventLocation && activeEventLocation.id === location.id) {
                                        eventButtonContainer.classList.add('hidden');
                                        activeEventLocation = null;
                                    }
                                    location.buttonVisible = false;
                                    console.log(`イベント地点「${location.name}」の範囲外に出ました。`);
                                }
                            }
                        });

                        // どのイベントもアクティブでない場合、イベントボタンを非表示にする
                        if (!foundActiveEvent && !eventButtonContainer.classList.contains('hidden')) {
                            eventButtonContainer.classList.add('hidden');
                            activeEventLocation = null;
                        }

                        loadingOverlay.classList.add('hidden');
                    },
                    (error) => {
                        console.error("Geolocation watch error:", error);
                        loadingOverlay.classList.add('hidden');
                        startButton.disabled = false;
                        stopButton.disabled = true;
                        let errorMessage = "現在地を取得できませんでした。";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "位置情報の利用が許可されていません。ブラウザの設定を確認してください。";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "位置情報が利用できません。";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "位置情報の取得がタイムアウトしました。電波の良い場所へ移動するか、インターネット接続を確認してください。";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage = "不明なエラーが発生しました。";
                                break;
                        }
                        console.error("Geolocationエラー:", errorMessage);
                        showMessageBox(errorMessage);
                        if (!map) {
                            initMap(DEFAULT_LAT, DEFAULT_LNG);
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 20000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log("Geolocation not supported.");
                loadingOverlay.classList.add('hidden');
                startButton.disabled = false;
                stopButton.disabled = true;
                const errorMessage = "お使いのブラウザはGeolocationをサポートしていません。";
                console.error(errorMessage);
                showMessageBox(errorMessage);
                if (!map) {
                    initMap(DEFAULT_LAT, DEFAULT_LNG);
                }
            }
        }

        // イベントボタンがクリックされた時の処理
        function handleEventButtonClick() {
            if (activeEventLocation) {
                console.log(`イベントボタンがクリックされました: ${activeEventLocation.name}`);
                showMessageBox(activeEventLocation.message);
                // ボタンはクリック後も表示されたままになります
            }
        }

        // ナビゲーションを停止する関数
        function stopGeolocationTracking() {
            console.log("stopGeolocationTracking called.");
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                lastPosition = null;
                showMessageBox("ナビゲーションを停止しました。");
                startButton.disabled = false;
                stopButton.disabled = true;
                eventButtonContainer.classList.add('hidden');
                activeEventLocation = null;

                // マーカーの回転をリセット
                if (marker) {
                    const markerElement = marker.getElement();
                    if (markerElement) {
                        const arrowElement = markerElement.querySelector('svg');
                        if (arrowElement) {
                            arrowElement.style.transform = `rotate(0deg)`;
                        }
                    }
                }
            }
        }

        // ゲームを開始する関数
        function startGame() {
            console.log("startGame called. Transitioning to game screen.");
            titleScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            // Leafletマップライブラリが読み込まれているか確認
            // このチェックは、Leafletスクリプトのonerrorハンドラと連携して、
            // ライブラリが利用できない場合にユーザーに通知します。
            if (typeof L === 'undefined' || typeof L.map === 'undefined') {
                const errorMessage = "Leafletマップライブラリの読み込みに失敗しました。インターネット接続を確認してください。";
                console.error(errorMessage);
                showMessageBox(errorMessage + " ゲームを開始できません。");
                loadingOverlay.classList.add('hidden');
                startButton.disabled = true;
                stopButton.disabled = true;
                startGameButton.disabled = true; // ゲームスタートボタンも無効化
                return; // Leafletが利用できない場合はここで処理を停止
            }

            // Leafletマップの初期化とGeolocationの追跡を開始
            initMap(DEFAULT_LAT, DEFAULT_LNG); // 初期位置でマップを表示
            startButton.disabled = false; // initMapが完了したら開始ボタンを有効化
            stopButton.disabled = true;
        }

        // ウィンドウがロードされたら、まずタイトル画面を表示し、ゲームスタートボタンにイベントリスナーを追加
        window.onload = () => {
            console.log("Window loaded. Displaying title screen.");
            titleScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            loadingOverlay.classList.add('hidden');
            messageBox.classList.add('hidden');

            startGameButton.addEventListener('click', startGame);

            // Leafletスクリプトのonerrorハンドラを設定
            // このハンドラは、Leaflet.jsファイルのダウンロード自体に失敗した場合に発火します。
            const leafletJsScript = document.getElementById('leafletJsScript');
            if (leafletJsScript) {
                leafletJsScript.onerror = () => {
                    console.error("Leaflet JavaScriptの読み込みに失敗しました。ネットワーク接続を確認してください。");
                    const errorMessage = "地図ライブラリの読み込みに失敗しました。インターネット接続を確認してください。";
                    showMessageBox(errorMessage + " ゲームを開始できません。");
                    loadingOverlay.classList.add('hidden');
                    startButton.disabled = true;
                    stopButton.disabled = true;
                    startGameButton.disabled = true; // ゲームスタートボタンも無効化
                };
            }
        };
    </script>
</body>
</html>
